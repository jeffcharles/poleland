---
- hosts: all
  tasks:
    - name: Update package cache
      apt: update_cache=yes
    - name: Install Node.js
      shell: wget http://nodejs.org/dist/v0.10.28/node-v0.10.28-linux-x64.tar.gz -O - | tar -C /usr/local --strip-components 1 -xzf -
               creates=/usr/local/bin/node
    - name: Install git
      apt: pkg=git-core
    - name: Install bower
      npm: name=bower global=yes version=1.3.2
    - name: Install Bower dependencies
      command: /usr/local/bin/bower install --allow-root chdir=/vagrant/ui
    - name: Install gulp
      npm: name=gulp global=yes version=3.6.0
    - name: Install NPM dependencies
      npm: path=/vagrant/api
    - name: Install apt-transport-https
      apt: pkg=apt-transport-https
    - name: Add key for Docker apt repo
      apt_key: keyserver=hkp://keyserver.ubuntu.com:80 id=A88D21E9 state=present
    - name: Add Docker repo to apt sources list
      apt_repository: repo='deb https://get.docker.io/ubuntu docker main' state=present
    - name: Install docker
      apt: pkg=lxc-docker=1.0.1
    - name: Build API docker image
      shell: docker build -t poleland-api /vagrant/api && touch /home/vagrant/poleland-api-built
               creates=/home/vagrant/poleland-api-built
    - name: Run API docker container
      shell: docker run -d --name=poleland-api-container -p 3000:3000 -v /vagrant/api:/app:ro -w /app/src poleland-api && touch /home/vagrant/poleland-api-running
               creates=/home/vagrant/poleland-api-running
    - name: Build UI docker image
      shell: docker build -t poleland-ui /vagrant/ui && touch /home/vagrant/poleland-ui-built
               creates=/home/vagrant/poleland-ui-built
    - name: Run UI docker container
      shell: docker run -d --name=poleland-ui-container -p 80:80 -v /vagrant/ui:/vagrant/ui:ro poleland-ui && touch /home/vagrant/poleland-ui-running
               creates=/home/vagrant/poleland-ui-running